#POWERSHELL SCRIPT TO BE DEPLOYED BY PY SCRIPT BELOW
param(
    [Parameter(Mandatory = $true)]
    [DateTime]$Date,

    [Parameter(Mandatory = $true)]
    [int]$IDinput
)
$IDinput = Read-Host "Enter Event ID"
$Date    = [datetime](Read-Host "Enter start date (e.g. 2024-12-01)")


Get-WinEvent  |
    Where-Object { $_.TimeCreated -gt $Date -and $_.Id -eq $IDinput } |
    ForEach-Object {
        "$($_.TimeCreated) - ID:$($_.Id) - $($_.Message)"
    } |
    Out-File "C:\Users\theri\OneDrive\Documents\WindowsPowerShell\Scripts\LogResult.txt"  #Switch this for write-host and it will return to the python script

# The LogParser.ps1 PS script above has the issue of event logs being so vast it takes minutes to receive this data
# So I ran the script once successfully, and saved the output to a json file (LogParser.json) which you can see me using below, The hashed out code does work
# But the time delays make it not worth it for this current version, I will find an alternative method to get this running smoothly.
import json  

#import subprocess 
#IdInput = input("Enter an event log ID")
#DateInput = input("Enter a date/time in the format: YYYY/MM/DD HH/mm/ss")
#completed = subprocess.run(
#    [ "powershell", 
#"-File", r"C:\Users\theri\OneDrive\Documents\WindowsPowerShell\Scripts\LogParser.ps1", 
#"-Date", DateInput, 
#"-IDinput", IdInput ],
#capture_output=True, text=True
#)
#print("PowerShell returned:", completed.stdout.strip())
def InputTaker(user_input):
    RowCount = 0
    UserRequest = []
    inpu = str(user_input)

    WarningCount = 0
    SuccessCount = 0

    # IMPORTANT: PowerShell Out-File defaults to UTF-16
    with open(
        r"C:\Users\theri\OneDrive\Documents\WindowsPowerShell\Scripts\LogResult.json",
        "r",
        encoding="utf-16"
    ) as file:
        for row in file:
            RowCount += 1

            if RowCount < 22:
                continue

            # Skip blank lines
            if row.strip() == "":
                continue

            # Count warnings
            if "warning" in row.lower():
                WarningCount += 1
              

            # Count successes
            if "success" in row.lower():
                SuccessCount += 1
                continue

            # Keyword match
            if inpu in row:
                UserRequest.append(row)
                continue

        Summary = {
        "Total Row count": RowCount,
        "Count of 'Warning' messages": WarningCount,
        "Count of Success messages": SuccessCount,
        "Row containing keyword": UserRequest,
    }

    # Write summary as plain text (Python dict string)
    with open(
        r"C:\Users\theri\OneDrive\Documents\WindowsPowerShell\Scripts\summary.txt",
        "w",
        encoding="utf-8"
    ) as file:
        file.write(str(Summary))


# Get the actual value from the user
user_keyword = input("Enter a keyword you'd like to scan for: ")
InputTaker(user_keyword)
